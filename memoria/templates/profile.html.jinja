{# profile.html.jinja #}
{% extends "base.html.jinja" %}
{% block title %}
    {{ title }}
{% endblock title %}
{% block content %}
    {% include "partials/navbar.html.jinja" %}
    <div class="container mt-5">
        <h1 class="mb-4">Your Profile</h1>
        {# Display django.contrib.messages as Bootstrap alerts #}
        {{ bootstrap_messages() }}
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="mb-3">{# Placeholder for user avatar or profile image if you add one #}</div>
                        <h5 class="card-title">{{ user.username }}</h5>
                        {# Display the current email address #}
                        <h6 class="card-subtitle mb-2 text-body-secondary">{{ user.email }}</h6>
                        <p class="card-text">
                            <p>Last Login: {{ user.last_login | naturaltime }}</p>
                        </p>
                        {# Display the current bio #}
                        {% if user.profile %}
                            <p class="card-text">Bio: {{ user.profile.bio | default("No bio yet.") }}</p>
                        {% else %}
                            <p class="card-text">Bio: No bio yet.</p>
                        {% endif %}
                        {# Display the current images per page setting #}
                        {% if user.profile %}
                            <p class="card-text">Images per page: {{ user.profile.images_per_page }}</p>
                        {% else %}
                            <p class="card-text">Images per page: N/A</p>
                        {% endif %}
                        <hr>
                        {# Add a separator before groups #}
                        <h6 class="card-subtitle mb-2 text-body-secondary">Groups</h6>
                        {# Iterate over the 'user_groups' context variable #}
                        {% if user_groups %}
                            <ul class="list-unstyled">
                                {% for group in user_groups %}<li>{{ group.name }}</li>{% endfor %}
                            </ul>
                        {% else %}
                            <p class="card-text">
                                <small>Not a member of any groups.</small>
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                {% if email_form %}
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Update Email Address</h5>
                            <form method="post" action="{{ url('profile_update_email') }}">
                                {% csrf_token %}
                                {{ bootstrap_form(email_form, show_label=False) }}
                                {{ bootstrap_button(button_type="submit", content="Update Email") }}
                            </form>
                        </div>
                    </div>
                {% endif %}
                {# Separate form for Profile Details (Bio, Images per page) #}
                {% if profile_form %}
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Update Profile Details</h5>
                            <form method="post" action="{{ url('profile_update_details') }}">
                                {% csrf_token %}
                                {{ bootstrap_form(profile_form) }}
                                {{ bootstrap_button(button_type="submit", content="Update Profile") }}
                            </form>
                        </div>
                    </div>
                {% endif %}
                {# Group Management Section for Staff Users - Now using a form #}
                {% if (user.is_staff or user.is_superuser) and group_form %}
                    {# Check user is staff and group_form exists #}
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Manage Groups</h5>
                            {# Display form errors if any #}
                            {% if group_form.errors %}
                                <div class="alert alert-danger">
                                    <strong>Please correct the following errors:</strong>
                                    <ul>
                                        {% for field, errors in group_form.errors.items() %}<li>{{ field }}: {{ errors | join(", ") }}</li>{% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                            <form method="post" action="{{ url('profile_manage_groups') }}">
                                {% csrf_token %}
                                {# Manually render the groups field using Bootstrap List Group and Form Switches #}
                                <ul class="list-group mb-3">
                                    {# Iterate through each choice in the form field #}
                                    {% for choice in group_form.groups %}
                                        {# Each list item represents a group with its name and a toggle switch #}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            {# Display the group name on the left #}
                                            <label class="form-check-label" for="switchCheckDefault">{{ choice.choice_label }}</label>
                                            {# The div for the form switch and its status label on the right #}
                                            <div class="form-check form-switch">
                                                {# Manually render the checkbox input with Bootstrap classes and dynamic attributes #}
                                                <input class="form-check-input"
                                                       type="checkbox"
                                                       role="switch"
                                                       id="{{ choice.id_for_label }}"
                                                       name="{{ choice.data.name }}"
                                                       value="{{ choice.data.value }}"
                                                       {% if choice.data.selected %}checked{% endif %}>
                                                {# Add 'checked' if the choice is selected #}
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                                <button type="submit" class="btn btn-success">Update Group Membership</button>
                            </form>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock content %}
